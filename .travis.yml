language: java

jdk:
  - oraclejdk8

env:
  - OUTPUT_ZIP=b2sdk4j-build-${TRAVIS_BUILD_NUMBER}-at-`date +%Y%m%d_%H%M%S`.zip

before_install:
  - mkdir -p ~/.gradle && echo "org.gradle.daemon=false" >> ~/.gradle/gradle.properties
  - sudo pip install b2

script:
  #
  # actually build
  #

  - ./gradlew build javadoc

  #
  # Prepare the outputs
  #

  # make the directory
  - mkdir build/outputs
  
  # copy the generated jar files
  - cp -v build/libs/b2sdk4j-*jar build/outputs

  # make the 'sources' zip
  - zip -r build/outputs/b2sdk4j-sources.zip src

  # make the javadocs zip
  - (cd build/docs && zip -r $TRAVIS_BUILD_DIR/build/outputs/b2sdk4j-javadocs.zip javadoc)

  # zip up the outputs
  - echo $OUTPUT_ZIP
  - zip build/$OUTPUT_ZIP build/outputs/*

  #
  # upload to b2
  #

  - b2 authorize_account $B2_ACCOUNT_ID $B2_APPLICATION_KEY
  - b2 upload_file --contentType application/octet b2sdk4j build/$OUTPUT_ZIP builds/$OUTPUT_ZIP

  # list all files to help debug stuff!
  - find $TRAVIS_BUILD_DIR

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/

deploy:
  provider: pages
  skip_cleanup: true
  github_token: $GITHUB_TOKEN
  local_dir: build/docs/javadoc
  on:
    branch: master
